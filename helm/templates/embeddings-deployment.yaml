{{- range $index, $service := .Values.embeddings }}
{{- $revision := (get $service "revision") }}
{{- $model := (get $service "model") }}
{{- $name := (get $service "name") }}
{{- if ne $index 0 }}
---
{{- end }}
apiVersion: apps/v1
kind: Deployment
metadata:
  name: embedding-{{ $name }}
  labels:
    app.kubernetes.io/name: embedding-{{ $name }}
    app.kubernetes.io/instance: {{ $.Release.Name }}
    app.kubernetes.io/managed-by: Helm
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: embedding-{{ $name }}
      app.kubernetes.io/instance: {{ $.Release.Name }}
  template:
    metadata:
      labels:
        app.kubernetes.io/name: embedding-{{ $name }}
        app.kubernetes.io/instance: {{ $.Release.Name }}
        app.kubernetes.io/managed-by: Helm
    spec:
      containers:
        - name: embedding-{{ $name }}
          image: ghcr.io/huggingface/text-embeddings-inference:86-1.1
          args: ["--model-id", "{{ $model }}", "--revision", "{{ $revision }}"]
          ports:
            - containerPort: 80
          volumeMounts:
            - name: embedding-data
              mountPath: /data
          resources:
            limits:
              nvidia.com/gpu: 1
      volumes:
        - name: embedding-data
          persistentVolumeClaim:
            claimName: embedding-{{ $name }}-pvc
{{- end }}
